<html>
<head>
	<!-- Cannon barrel textures provided by:
			http://www.flickriver.com/photos/steffen-larsen/tags/textures/
			http://shortformvideo.co.uk/product/texturepak1/
			https://www.pinterest.com/pin/397935317051513848/
		 Cannonball textures provided by:
			http://imagestack.co/218445021-shop-textures.html
			http://www.dreamstime.com/stock-images-quartz-porphyry-rhyolite-estonia-image25775514
	-->
	<title>Siege Warfare</title>
	<!-- WebGL wrapper library -->
	<script src="js/three.js"></script>
	<!-- Physics Engine -->
	<script src="js/physi.js"></script>
	<!-- Allows for keyboard listeners -->
	<script src="js/threex.keyboardstate.js"></script>
	<!-- Gives user ability to manipulate camera angle -->
	<script src="js/OrbitControls.js"></script>
	<!-- Font used to make scoreboard label, and score -->
	<script src='fonts/helvetiker_regular.typeface.js'></script>
	<!-- Global variables -->
	<script src="js/data.js"></script>
	<!-- All things related to cannons -->
	<script src="js/cannon.js"></script>
	<!-- All things related to terrain -->
	<script src="js/terrain.js"></script>
</head>
<body>

<script>	
	var targetlist;
	function GenerateTarget()
	{
		targetlist = [];
		
		for( var i=0; i<4; i++ )
		{
			var geo = new THREE.BoxGeometry( 4, 4, 12 );
			var mat = Physijs.createMaterial( new THREE.MeshLambertMaterial({color:'blue'}), .95, .95 );
			var msh = new Physijs.BoxMesh( geo, mat );
			switch( i )
			{
				case 0: msh.position.x = 80; break;
				case 1: msh.position.x = 85; msh.position.y = 5; break;
				case 2: msh.position.x = 90; break;
				case 3: msh.position.x = 85; msh.position.y = -5; break;
			}
			msh.position.z = 6;
			targetlist.push( msh );
			scene.add( msh );
		}
		
	}
	
	function init()
	{
		keyboard = new THREEx.KeyboardState();

		WIDTH = (window.innerWidth) * 0.97;
		HEIGHT = (window.innerHeight) * 0.97;
	
		scene = new Physijs.Scene();
		scene.setGravity(new THREE.Vector3( 0, 0, -30 ));
		scene.addEventListener('update', function() 
		{
			scene.simulate();
		});
		
		camera = new THREE.PerspectiveCamera( 75, WIDTH / HEIGHT, 0.1, 1000 );
		camera.position.x = 0;
		camera.position.y = -100;
		camera.position.z = 250;
		camera.lookAt( scene.position );
		
		renderer = new THREE.WebGLRenderer();
		renderer.setClearColor( 0x000000, 1.0 );
		renderer.setSize( WIDTH, HEIGHT );
		renderer.shadowMapEnabled = true;

		// 1. Drop in ground plane
		var terrain = GenerateTerrain();
		scene.add( terrain[0] );
		scene.add( terrain[1] );

		// Generate cannon
		cannon = GenerateCannon();
		scene.add( cannon );
		
		// Generate target
		GenerateTarget();

        var spotLight = new THREE.DirectionalLight( 0xffffff );
        spotLight.position.set( 0, -30, 150 );
        spotLight.shadowCameraNear = 1;
        spotLight.shadowCameraFar = 1000;
        spotLight.castShadow = true;
		spotLight.intensity = 1.3;
        scene.add(spotLight);
		
		scene.simulate();
		
		document.body.appendChild( renderer.domElement );
		orbControls = new THREE.OrbitControls( camera, renderer.domElement );		
		render();
	}

	function render()
	{
		updateCounter++;
		updateCounter = updateCounter % 60;
		if( keyboard.pressed("left") )
		{
			cannon.rotateOnAxis(new THREE.Vector3( 0, 0, 1 ), 0.01);
		}
		else if( keyboard.pressed("right") )
		{
			cannon.rotateOnAxis(new THREE.Vector3( 0, 0, 1 ), -0.01);
		}
		else if( keyboard.pressed("up") )
		{
			cannon.rotateOnAxis(new THREE.Vector3( 1, 0, 0 ), -0.01);
		}	
		else if( keyboard.pressed("down") )
		{
			cannon.rotation.y += 0.02;
			if( cannon.rotation.y > 0 )
			{
				cannon.rotation.y = 0;
			}
		}
		else if( keyboard.pressed("camera-one") )
		{
			camera.position.x = 0;
			camera.position.y = -100;
			camera.position.z = 250;
			camera.lookAt( scene.position );
		}
		else if( keyboard.pressed("camera-two") )
		{
			//camera.rotation.x = Math.PI / 180;
			camera.rotation = (3, 4, 5);
			camera.position.x = cannon.position.x - 10;
			camera.position.y = cannon.position.y;
			camera.position.z = cannon.position.z + 10;
			camera.lookAt( cannon.position );
		}
		else if( keyboard.pressed("ball-change") )
		{
			caliber = (caliber + 1) % 3;
			console.log(caliber);
		}
		else if( !balllaunched && keyboard.pressed("space") )
		{
			balllaunched = true;
			// Generate cannon ball
			ball = GenerateCannonBall(caliber);
			scene.add( ball );
			ball.applyCentralImpulse( new THREE.Vector3( 10000, -( Math.PI / 2 - cannon.rotation.z ) * 4000, -cannon.rotation.y * 10000 ) );
		}
		else if( balllaunched && keyboard.pressed("enter") )
		{
			balllaunched = false;
			scene.remove( ball );
			// Generate cannon ball
			ball = GenerateCannonBall(caliber);
		}
		
		if( balllaunched )
		{
			if( ball.position.z < -5 )
			{
				balllaunched = false;
				scene.remove( ball );
				// Generate cannon ball
				ball = GenerateCannonBall(caliber);
			}
		}
	
		requestAnimationFrame( render );
		renderer.render( scene, camera );
	}
	
	window.onload = init;

</script>
</body>
</html>
