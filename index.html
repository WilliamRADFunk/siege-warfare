<html>
<head>
	<title>Siege Warfare</title>
	<!-- WebGL wrapper library -->
	<script src="js/external/three.js"></script>
	<!-- Physics Engine -->
	<script src="js/external/physi.js"></script>
	<!-- Tree Generator -->
	<script src="js/external/proctree.js"></script>
	<!-- Allows for keyboard listeners -->
	<script src="js/external/threex.keyboardstate.js"></script>
	<!-- Gives user ability to manipulate camera angle -->
	<script src="js/external/OrbitControls.js"></script>
	<!-- Font used to make scoreboard label, and score -->
	<script src='fonts/helvetiker_regular.typeface.js'></script>
	<!-- Global variables -->
	<script src="js/data.js"></script>
	<!-- Generates cameras -->
	<script src="js/camera.js"></script>
	<!-- Generates terrain -->
	<script src="js/cannon.js"></script>
	<!-- Generates terrain -->
	<script src="js/terrain.js"></script>
	<!-- Generates castles -->
	<script src="js/castle.js"></script>
	<!-- Allows for keyboard listeners -->
	<script src="js/controls.js"></script>
</head>
<body>

<script>
	Physijs.scripts.worker = 'js/external/physijs_worker.js';
	Physijs.scripts.ammo = 'ammo.js';

	function loadSoundFX()
	{
		background_gunfire_01 = new Audio("assets/audio/background-gunfire-01.mp3");
		background_gunfire_02 = new Audio("assets/audio/background-gunfire-02.mp3");
		background_gunfire_03 = new Audio("assets/audio/background-gunfire-03.mp3");
		cannon_fire_01 = new Audio("assets/audio/cannon-fire-01.wav");
		cannon_fire_02 = new Audio("assets/audio/cannon-fire-02.mp3");
		cannon_fire_03 = new Audio("assets/audio/cannon-fire-03.mp3");
		cannon_fire_04 = new Audio("assets/audio/cannon-fire-04.wav");
		cannon_turning_01 = new Audio("assets/audio/cannon-turning-01.wav");
		cannon_ammochange_01 = new Audio("assets/audio/cannon-ammochange-01.wav");
		collision_explosion_01 = new Audio("assets/audio/collision-explosion-01.mp3");
		collision_explosion_02 = new Audio("assets/audio/collision-explosion-02.mp3");
		collision_explosion_03 = new Audio("assets/audio/collision-explosion-03.mp3");
		collision_explosion_04 = new Audio("assets/audio/collision-explosion-04.mp3");
		theme_beach_01 = new Audio("assets/audio/theme-beach-01.mp3");
		theme_beach_01.loop = true;
		theme_beach_02 = new Audio("assets/audio/theme-beach-02.mp3");
		theme_rainforest_01 = new Audio("assets/audio/theme-rainforest-01.mp3");
		theme_rainforest_01.loop = true;
		theme_thunder_01 = new Audio("assets/audio/theme-thunder-01.mp3");
		theme_thunder_02 = new Audio("assets/audio/theme-thunder-02.mp3");
		theme_thunder_03 = new Audio("assets/audio/theme-thunder-03.mp3");
		theme_thunder_04 = new Audio("assets/audio/theme-thunder-04.mp3");
		theme_thunder_05 = new Audio("assets/audio/theme-thunder-05.mp3");
		theme_thunder_06 = new Audio("assets/audio/theme-thunder-06.mp3");
		theme_thunder.push(theme_thunder_01);
		theme_thunder.push(theme_thunder_02);
		theme_thunder.push(theme_thunder_03);
		theme_thunder.push(theme_thunder_04);
		theme_thunder.push(theme_thunder_05);
		theme_thunder.push(theme_thunder_06);
		background_gunfire.push(background_gunfire_01);
		background_gunfire.push(background_gunfire_01);
		background_gunfire.push(background_gunfire_01);
		cannon_fire.push(cannon_fire_01);
		cannon_fire.push(cannon_fire_02);
		cannon_fire.push(cannon_fire_03);
		cannon_fire.push(cannon_fire_04);
	}
	
	function init()
	{
		loadSoundFX();

		keyboard = new THREEx.KeyboardState();

		WIDTH = (window.innerWidth) * 0.97;
		HEIGHT = (window.innerHeight) * 0.97;
	
		scene = new Physijs.Scene();
		scene.setGravity(new THREE.Vector3( 0, 0, -30 ));
		scene.addEventListener('update', function() 
		{
			scene.simulate();
		});

		// Generate cameras
		GenerateCameras();
		camera = camera1;
		
		renderer = new THREE.WebGLRenderer();
		renderer.setClearColor( 0x000000, 1.0 );
		renderer.setSize( WIDTH, HEIGHT );
		renderer.shadowMapEnabled = true;

		// Controls landscape textures, castle brick textures,
		// SoundFX, and more.
		theme = Math.floor((Math.random() * 3));

		// Generate ground, sky, and walls.
		var terrain = GenerateTerrain( theme );
		scene.add( terrain[0] );
		scene.add( terrain[1] );
		scene.add( terrain[2] );
		scene.add( terrain[3] );
		scene.add( terrain[4] );
		scene.add( terrain[5] );

		// Generate cannon
		cannon = GenerateCannon();
		scene.add( cannon );

		// Load textures
		ball1Texture = THREE.ImageUtils.loadTexture('assets/textures/guns/cannonball-1.jpg');
		ball2Texture = THREE.ImageUtils.loadTexture('assets/textures/guns/cannonball-2.jpg');
		ball3Texture = THREE.ImageUtils.loadTexture('assets/textures/guns/cannonball-3.jpg');

		if(theme == 0)
		{
			brickTexture = THREE.ImageUtils.loadTexture('assets/textures/materials/brick-5.jpg');
			theme_beach_01.autoplay = true;
		}
		else if(theme == 1)
		{
			brickTexture = THREE.ImageUtils.loadTexture('assets/textures/materials/brick-4.jpg');
			theme_rainforest_01.autoplay = true;
		}
		else
		{
			brickTexture = THREE.ImageUtils.loadTexture('assets/textures/materials/brick-2.jpg');
			theme_thunder[Math.floor((Math.random() * 5))].play();
		}
		background_gunfire[Math.floor((Math.random() * 2))].play();
		

		// Generate a castle
		castle = CreateCastle(castleTemplate1);

        var directionalLight = new THREE.DirectionalLight( 0xffffff );
        directionalLight.position.set( 0, -30, 150 );
        directionalLight.shadowCameraNear = 1;
        directionalLight.shadowCameraFar = 1000;
        directionalLight.castShadow = true;
		directionalLight.intensity = 1.3;
        scene.add(directionalLight);
		
		scene.simulate();
		
		document.body.appendChild( renderer.domElement );
		orbControls = new THREE.OrbitControls( camera3, renderer.domElement );		
		render();
	}

	function render()
	{
		updateCounter++;
		lastFired--;

		// Keeps the counter from getting too large.
		if(updateCounter > 6000)
		{
			updateCounter = 0;
		}

		// Listens for a keyboard key press.
		KeyPressed();

		// Makes sure ammo type change happens once per click.
		if(updateCounter % 55 == 0)
		{
			ballChanged = false;
		}

		// Removes bricks and cannonballs that are out of bounds.
		if(updateCounter % 59 == 0)
		{
			for( var i = 0; i < castle.length; i++ )
			{
				if(castle[i].position.z < 0 || castle[i].position.x > 180)
				{
					console.log("Removing brick# ", castle[i].id);
					scene.remove(castle[i]);
					castle.splice(i, 1);
				}
			}

			for( var j = 0; j < ballList.length; j++ )
			{
				if(ballList[j].position.z < 0 || ballList[j].position.x > 180)
				{
					console.log("Removing cannonball# ", ballList[j].id);
					scene.remove(ballList[j]);
					ballList.splice(j, 1);
				}
			}
		}

		// Plays background sounds for theme #3
		if(updateCounter % 499 == 0)
		{
			if(theme == 2)
			{
				theme_thunder[Math.floor((Math.random() * 5))].play();
			}
		}

		// Plays background sounds for war
		if(updateCounter % 599 == 0)
		{
			background_gunfire[Math.floor((Math.random() * 2))].play();
		}

		// Removes cannonballs after a reasonable amount of time.
		if( (updateCounter % 1199 == 0 && ballList.length > 1) || (ballList.length >= 30) )
		{
			console.log("Removing cannonball# ", ballList[0].id);
			scene.remove(ballList[0]);
			ballList.splice(0, 1);
		}

		requestAnimationFrame( render );
		renderer.render( scene, camera );
	}
	
	window.onload = init;

</script>
</body>
<!-- Cannon barrel textures provided by:
		http://www.flickriver.com/photos/steffen-larsen/tags/textures/
		http://shortformvideo.co.uk/product/texturepak1/
		https://www.pinterest.com/pin/397935317051513848/
	 Cannonball textures provided by:
		http://imagestack.co/218445021-shop-textures.html
		http://www.dreamstime.com/stock-images-quartz-porphyry-rhyolite-estonia-image25775514
	 Landscape & sky textures provided by:
		http://www.cryengine.com/community/viewtopic.php?f=309&t=104955&start=30
		http://texaskellers.com/2013/06/11/colorado-springs-to-santa-fe-n-m/
		http://blog.jebbo.co.uk/2008/09/
		http://www.michellefirmentreid.com/blog/2011/07/
		http://www.clodaghobrien.com/tag/relationship/
		http://allthingsprecious.deviantart.com/art/Darkness-Texture-2-411014813
		http://blog.olivierdutre.com/2011/07/step-by-step.html
		http://sineluce-stock.deviantart.com/art/crack-texture-198448227
		http://sftextures.com/2014/10/17/mysterious-ground-dark-dodge-asphalt-sunny-spots-cave-holes-texture/
	 SoundFX provided by:
	 	http://soundbible.com/909-Cannon.html
	 	http://soundbible.com/284-Bullets-Guns-Cannons.html
	 	http://soundbible.com/1339-Sonic-Boom.html
	 	http://soundbible.com/1468-Depth-Charge-Shorter.html
	 	http://soundbible.com/1854-More-Thunder.html
	 	http://soundbible.com/1837-Lightning-Bolt-Light-Rain.html
	 	http://soundbible.com/1835-More-Thunder-2.html
	 	http://soundbible.com/907-Distant-Thunder.html
	 	http://soundbible.com/916-Perfect-Thunder-Storm.html
	 	http://soundbible.com/886-Distant-Thunder-And-Light-Rain.html
	 	http://soundbible.com/2078-Gun-Battle-Sound.html
	 	http://soundbible.com/1919-Shotgun-Blast.html
	 	http://soundbible.com/1807-Explosion-Ultra-Bass.html
	 	http://soundbible.com/1367-Grenade.html
	 	http://soundbible.com/1234-Bomb.html
	 	http://soundbible.com/576-Barrel-Exploding.html
	 	http://soundbible.com/483-Explosion.html
	 	http://soundbible.com/1818-Rainforest-Ambience.html
	 	http://soundbible.com/1991-Sounds-Of-War-V-10.html
	 	http://soundbible.com/1936-Crisp-Ocean-Waves.html
	 	http://soundbible.com/1935-Ocean-Waves.html
	 	http://www.audiomicro.com/free-sound-effects/free-industrial-and-machinery
	 Castle textures provided by:
	 	http://slodive.com/freebies/brick-texture/
	 	http://beemirror.com/freebies/free-brick-texture-designs/
	 	http://www.bricksntiles.com/community/viewtopic.php?t=107&sid=0a73404b552cc904d44dca6af5d66853
	 	http://www.turbosquid.com/FullPreview/Index.cfm/ID/728322
	-->
</html>
