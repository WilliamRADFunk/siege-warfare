<html>
<head>
	<!-- Cannon barrel textures provided by:
			http://www.flickriver.com/photos/steffen-larsen/tags/textures/
			http://shortformvideo.co.uk/product/texturepak1/
			https://www.pinterest.com/pin/397935317051513848/
		 Cannonball textures provided by:
			http://imagestack.co/218445021-shop-textures.html
			http://www.dreamstime.com/stock-images-quartz-porphyry-rhyolite-estonia-image25775514
		 Landscape & sky textures provided by:
			http://www.cryengine.com/community/viewtopic.php?f=309&t=104955&start=30
			http://texaskellers.com/2013/06/11/colorado-springs-to-santa-fe-n-m/
			http://blog.jebbo.co.uk/2008/09/
			http://www.michellefirmentreid.com/blog/2011/07/
			http://www.clodaghobrien.com/tag/relationship/
			http://allthingsprecious.deviantart.com/art/Darkness-Texture-2-411014813
			http://blog.olivierdutre.com/2011/07/step-by-step.html
			http://sineluce-stock.deviantart.com/art/crack-texture-198448227
			http://sftextures.com/2014/10/17/mysterious-ground-dark-dodge-asphalt-sunny-spots-cave-holes-texture/
	-->
	<title>Siege Warfare</title>
	<!-- WebGL wrapper library -->
	<script src="js/external/three.js"></script>
	<!-- Physics Engine -->
	<script src="js/external/physi.js"></script>
	<!-- Tree Generator -->
	<script src="js/external/proctree.js"></script>
	<!-- Allows for keyboard listeners -->
	<script src="js/external/threex.keyboardstate.js"></script>
	<!-- Gives user ability to manipulate camera angle -->
	<script src="js/external/OrbitControls.js"></script>
	<!-- Font used to make scoreboard label, and score -->
	<script src='fonts/helvetiker_regular.typeface.js'></script>
	<!-- Global variables -->
	<script src="js/data.js"></script>
	<!-- Generates cameras -->
	<script src="js/camera.js"></script>
	<!-- Generates terrain -->
	<script src="js/cannon.js"></script>
	<!-- Generates terrain -->
	<script src="js/terrain.js"></script>
	<!-- Generates castles -->
	<script src="js/castle.js"></script>
	<!-- Allows for keyboard listeners -->
	<script src="js/controls.js"></script>
</head>
<body>

<script>
	Physijs.scripts.worker = 'js/external/physijs_worker.js';
	Physijs.scripts.ammo = 'ammo.js';

	var explode, one, two, three, four, five;
	function loadSoundFX()
	{
		explode = new Audio("Explosion.mp3");
		one = new Audio("1.mp3");
		two = new Audio("2.mp3");
		three = new Audio("3.mp3");
		four = new Audio("4.mp3");
		five = new Audio("5.mp3");
	}
	
	function init()
	{
		keyboard = new THREEx.KeyboardState();

		WIDTH = (window.innerWidth) * 0.97;
		HEIGHT = (window.innerHeight) * 0.97;
	
		scene = new Physijs.Scene();
		scene.setGravity(new THREE.Vector3( 0, 0, -30 ));
		scene.addEventListener('update', function() 
		{
			scene.simulate();
		});

		// Generate cameras
		GenerateCameras();
		camera = camera1;
		
		renderer = new THREE.WebGLRenderer();
		renderer.setClearColor( 0x000000, 1.0 );
		renderer.setSize( WIDTH, HEIGHT );
		renderer.shadowMapEnabled = true;

		// Generate ground, sky, and walls.
		var terrain = GenerateTerrain( Math.floor((Math.random() * 3)) );
		scene.add( terrain[0] );
		scene.add( terrain[1] );
		scene.add( terrain[2] );
		scene.add( terrain[3] );
		scene.add( terrain[4] );
		scene.add( terrain[5] );

		// Generate cannon
		cannon = GenerateCannon();
		scene.add( cannon );

		// Load ball textures
		ball1Texture = THREE.ImageUtils.loadTexture('assets/textures/guns/cannonball-1.jpg');
		ball2Texture = THREE.ImageUtils.loadTexture('assets/textures/guns/cannonball-2.jpg');
		ball3Texture = THREE.ImageUtils.loadTexture('assets/textures/guns/cannonball-3.jpg');

		// Load brick texture
		brickTexture = THREE.ImageUtils.loadTexture('assets/textures/materials/brick-1.jpg');

		// Generate a castle
		castle = CreateCastle(castleTemplate1);

        var directionalLight = new THREE.DirectionalLight( 0xffffff );
        directionalLight.position.set( 0, -30, 150 );
        directionalLight.shadowCameraNear = 1;
        directionalLight.shadowCameraFar = 1000;
        directionalLight.castShadow = true;
		directionalLight.intensity = 1.3;
        scene.add(directionalLight);
		
		scene.simulate();
		
		document.body.appendChild( renderer.domElement );
		orbControls = new THREE.OrbitControls( camera3, renderer.domElement );		
		render();
	}

	function render()
	{
		updateCounter++;
		lastFired--;

		// Keeps the counter from getting too large.
		if(updateCounter > 6000)
		{
			updateCounter = 0;
		}

		// Listens for a keyboard key press.
		KeyPressed();

		// Makes sure ammo type change happens once per click.
		if(updateCounter % 45 == 0)
		{
			ballChanged = false;
		}

		// Removes bricks and cannonballs that are out of bounds.
		if(updateCounter % 59 == 0)
		{
			for( var i = 0; i < castle.length; i++ )
			{
				if(castle[i].position.z < 0 || castle[i].position.x > 180)
				{
					console.log("Removing brick# ", castle[i].id);
					scene.remove(castle[i]);
					castle.splice(i, 1);
				}
			}

			for( var j = 0; j < ballList.length; j++ )
			{
				if(ballList[j].position.z < 0 || ballList[j].position.x > 180)
				{
					console.log("Removing cannonball# ", ballList[j].id);
					scene.remove(ballList[j]);
					ballList.splice(j, 1);
				}
			}
		}

		// Removes cannonballs after a reasonable amount of time.
		if( (updateCounter % 1200 == 0 && ballList.length > 1) || (ballList.length >= 30) )
		{
			console.log("Removing cannonball# ", ballList[0].id);
			scene.remove(ballList[0]);
			ballList.splice(0, 1);
		}

		requestAnimationFrame( render );
		renderer.render( scene, camera );
	}
	
	window.onload = init;

</script>
</body>
</html>
