<html>
<head>
	<!-- Cannon barrel textures provided by:
			http://www.flickriver.com/photos/steffen-larsen/tags/textures/
			http://shortformvideo.co.uk/product/texturepak1/
			https://www.pinterest.com/pin/397935317051513848/
	-->
	<title>Siege Warfare</title>
	<!-- WebGL wrapper library -->
	<script src="js/three.js"></script>
	<!-- Physics Engine -->
	<script src="js/physi.js"></script>
	<!-- Allows for keyboard listeners -->
	<script src="js/threex.keyboardstate.js"></script>
	<!-- Gives user ability to manipulate camera angle -->
	<script src="js/OrbitControls.js"></script>
	<!-- Font used to make scoreboard label, and score -->
	<script src='fonts/helvetiker_regular.typeface.js'></script>
	<!-- Global variables -->
	<script src="js/data.js"></script>
	<!-- All things related to cannons -->
	<script src="js/cannon.js"></script>
</head>
<body>

<script>	
	function GenerateGroundPlane()
	{
		var groundTexture = THREE.ImageUtils.loadTexture('assets/groundterrain2.png');
		var groundMaterial = new Physijs.createMaterial(new THREE.MeshLambertMaterial({map:groundTexture}), .4, .8 );
		var groundGeometry = new THREE.PlaneGeometry( 400, 400, 6 );
		ground = new Physijs.BoxMesh( groundGeometry, groundMaterial, 0 );
		scene.add( ground );

		var undergroundTexture = THREE.ImageUtils.loadTexture('assets/undrgrd.png');
		var undergroundMaterial = new THREE.MeshLambertMaterial({map: undergroundTexture});
		var undergroundGeometry = new THREE.BoxGeometry(400, 400, 100);
		var underground = new THREE.Mesh(undergroundGeometry, undergroundMaterial);
		scene.add( underground );
		underground.position.z -= 51;

	}
	
	var targetlist;
	function GenerateTarget()
	{
		targetlist = [];
		
		for( var i=0; i<4; i++ )
		{
			var geo = new THREE.BoxGeometry( 4, 4, 12 );
			var mat = Physijs.createMaterial( new THREE.MeshLambertMaterial({color:'blue'}), .95, .95 );
			var msh = new Physijs.BoxMesh( geo, mat );
			switch( i )
			{
				case 0: msh.position.x = 80; break;
				case 1: msh.position.x = 85; msh.position.y = 5; break;
				case 2: msh.position.x = 90; break;
				case 3: msh.position.x = 85; msh.position.y = -5; break;
			}
			msh.position.z = 6;
			targetlist.push( msh );
			scene.add( msh );
		}
		
	}
	
	function init()
	{
		keyboard = new THREEx.KeyboardState();

		WIDTH = (window.innerWidth) * 0.97;
		HEIGHT = (window.innerHeight) * 0.97;
	
		scene = new Physijs.Scene();
		scene.setGravity(new THREE.Vector3( 0, 0, -30 ));
		scene.addEventListener('update', function() 
		{
			scene.simulate();
		});
		
		camera = new THREE.PerspectiveCamera( 75, WIDTH / HEIGHT, 0.1, 1000 );
		camera.position.x = 0;
		camera.position.y = -100;
		camera.position.z = 250;
		camera.lookAt( scene.position );
		
		renderer = new THREE.WebGLRenderer();
		renderer.setClearColor( 0x000000, 1.0 );
		renderer.setSize( WIDTH, HEIGHT );
		renderer.shadowMapEnabled = true;

		// 1. Drop in ground plane
		GenerateGroundPlane();

		// Generate cannon
		cannon = GenerateCannon();
		scene.add( cannon );
		
		// Generate cannon ball
		GenerateCannonBall();
		
		// Generate target
		GenerateTarget();

        var spotLight = new THREE.DirectionalLight( 0xffffff );
        spotLight.position.set( 0, -30, 150 );
        spotLight.shadowCameraNear = 1;
        spotLight.shadowCameraFar = 1000;
        spotLight.castShadow = true;
		spotLight.intensity = 1.3;
        scene.add(spotLight);
		
		scene.simulate();
		
		document.body.appendChild( renderer.domElement );
		orbControls = new THREE.OrbitControls( camera, renderer.domElement );		
		render();
	}

	function render()
	{
		if( keyboard.pressed("left") )
		{
			cannon.rotation.z += 0.01;
		}
		else if( keyboard.pressed("right") )
		{
			cannon.rotation.z -= 0.01;
		}
		else if( keyboard.pressed("up") )
		{
			cannon.rotation.y -= 0.02;
			if( cannon.rotation.y < -( Math.PI / 5 ) )
			{
				cannon.rotation.y = -( Math.PI / 5 );
			}
		}	
		else if( keyboard.pressed("down") )
		{
			cannon.rotation.y += 0.02;
			if( cannon.rotation.y > 0 )
			{
				cannon.rotation.y = 0;
			}
		}
		else if( !balllaunched && keyboard.pressed("space") )
		{
			balllaunched = true;
			scene.add( ball );
			ball.applyCentralImpulse( new THREE.Vector3( 8000, -( Math.PI / 2 - cannon.rotation.z ) * 4000, -cannon.rotation.y * 10000 ) );
		}
		else if( balllaunched && keyboard.pressed("escape") )
		{
			balllaunched = false;
			scene.remove( ball );
			GenerateCannonBall();
		}
		
		if( balllaunched )
		{
			if( ball.position.z < -5 )
			{
				balllaunched = false;
				scene.remove( ball );
				GenerateCannonBall();
			}
		}
	
		requestAnimationFrame( render );
		renderer.render( scene, camera );
	}
	
	window.onload = init;

</script>
</body>
</html>
