<html>
<head>
	<!-- Cannon barrel textures provided by:
			http://www.flickriver.com/photos/steffen-larsen/tags/textures/
			http://shortformvideo.co.uk/product/texturepak1/
			https://www.pinterest.com/pin/397935317051513848/
		 Cannonball textures provided by:
			http://imagestack.co/218445021-shop-textures.html
			http://www.dreamstime.com/stock-images-quartz-porphyry-rhyolite-estonia-image25775514
	-->
	<title>Siege Warfare</title>
	<!-- WebGL wrapper library -->
	<script src="js/external/three.js"></script>
	<!-- Physics Engine -->
	<script src="js/external/physi.js"></script>
	<!-- Tree Generator -->
	<script src="js/external/proctree.js"></script>
	<!-- Allows for keyboard listeners -->
	<script src="js/external/threex.keyboardstate.js"></script>
	<!-- Gives user ability to manipulate camera angle -->
	<script src="js/external/OrbitControls.js"></script>
	<!-- Font used to make scoreboard label, and score -->
	<script src='fonts/helvetiker_regular.typeface.js'></script>
	<!-- Global variables -->
	<script src="js/data.js"></script>
	<!-- Generates cameras -->
	<script src="js/camera.js"></script>
	<!-- Generates terrain -->
	<script src="js/cannon.js"></script>
	<!-- Generates terrain -->
	<script src="js/terrain.js"></script>
	<!-- Generates castles -->
	<script src="js/castle.js"></script>
	<!-- Allows for keyboard listeners -->
	<script src="js/controls.js"></script>
</head>
<body>

<script>
	Physijs.scripts.worker = 'js/external/physijs_worker.js';
	Physijs.scripts.ammo = 'ammo.js';
	
	function init()
	{
		keyboard = new THREEx.KeyboardState();

		WIDTH = (window.innerWidth) * 0.97;
		HEIGHT = (window.innerHeight) * 0.97;
	
		scene = new Physijs.Scene();
		scene.setGravity(new THREE.Vector3( 0, 0, -30 ));
		scene.addEventListener('update', function() 
		{
			scene.simulate();
		});

		// Generate cameras
		GenerateCameras();
		camera = camera1;
		
		renderer = new THREE.WebGLRenderer();
		renderer.setClearColor( 0x000000, 1.0 );
		renderer.setSize( WIDTH, HEIGHT );
		renderer.shadowMapEnabled = true;

		// 1. Drop in ground plane
		var terrain = GenerateTerrain();
		scene.add( terrain[0] );
		// /scene.add( terrain[1] );

		// Generate cannon
		cannon = GenerateCannon();
		scene.add( cannon );

		// Load ball textures
		ball1Texture = THREE.ImageUtils.loadTexture('assets/cannonball-1.jpg');
		ball2Texture = THREE.ImageUtils.loadTexture('assets/cannonball-2.jpg');
		ball3Texture = THREE.ImageUtils.loadTexture('assets/cannonball-3.jpg');

		// Load brick texture
		brickTexture = THREE.ImageUtils.loadTexture('assets/brick-1.jpg');

		// Generate a castle
		castle = CreateCastle();

        var spotLight = new THREE.DirectionalLight( 0xffffff );
        spotLight.position.set( 0, -30, 150 );
        spotLight.shadowCameraNear = 1;
        spotLight.shadowCameraFar = 1000;
        spotLight.castShadow = true;
		spotLight.intensity = 1.3;
        scene.add(spotLight);
		
		scene.simulate();
		
		document.body.appendChild( renderer.domElement );
		orbControls = new THREE.OrbitControls( camera3, renderer.domElement );		
		render();
	}

	function render()
	{
		updateCounter++;
		lastFired--;
		if(updateCounter > 6000)
		{
			updateCounter = 0;
		}

		KeyPressed();

		if(updateCounter % 20 == 0)
		{
			ballChanged = false;
		}

		if(updateCounter % 59 == 0)
		{
			for( var i = 0; i < castle.length; i++ )
			{
				if(castle[i].position.z < 0 || castle[i].position.x > 180)
				{
					console.log("Removing brick# ", castle[i].id);
					scene.remove(castle[i]);
					castle.splice(i, 1);
				}
			}

			for( var j = 0; j < ballList.length; j++ )
			{
				if(ballList[j].position.z < 0 || ballList[j].position.x > 180)
				{
					console.log("Removing cannonball# ", ballList[j].id);
					scene.remove(ballList[j]);
					ballList.splice(j, 1);
				}
			}
		}

		if(updateCounter % 1200 == 0 && ballList.length > 0)
		{
			console.log("Removing cannonball# ", ballList[0].id);
			scene.remove(ballList[0]);
			ballList.splice(0, 1);
		}

		console.log(cannon.rotation);

		requestAnimationFrame( render );
		renderer.render( scene, camera );
	}
	
	window.onload = init;

</script>
</body>
</html>
